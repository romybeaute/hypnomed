
embmat_path = '/home/romy.beaute/projects/hypnomed/diffusion_embedding/emb_matrices'
emb_states = '/home/romy.beaute/projects/hypnomed/diffusion_embedding/emb_matrices/group_control_meditation_hypnose_embedding.mat'
emb_blocks = '/home/romy.beaute/projects/hypnomed/diffusion_embedding/emb_matrices/group_run-1_run-2_run-3_embedding.mat'


emb = load(emb_states);

subs_emb = emb.subs;
emb = emb.emb;

mean_emb= mean(emb,1);

corr_emb = zeros(2,2,120);
for i=1:120
[R, P]= corrcoef(squeeze(mean_emb(:,:,1)), squeeze(emb(i,:,1)));
corr_emb(:,:,i)= R;
end


%plot of correlation coefficients
X = linspace(0,1.5,1000);

cf = figure
corr_plot= histfit(squeeze(corr_emb(1,2,:)));
saveas(cf,'/home/romy.beaute/projects/hypnomed/analysis/diffusion_embedding_analysis/corrplot_fisher.png')

%plot of fisher z-transformed correlation coefficients

Z = zeros(1,120);
for i=1:120
r = corr_emb(1,2,i);
Z(:,i) = .5*log10(r+1)/log10(exp(1))-.5*log10(1-r)/log10(exp(1));
%could have used atanh() function which computes the same
end

mean_z = mean(Z,2);
std_z = std(Z,0,2);
under_lim = mean_z - 1.6*std_z;
super_lim = mean_z + 1.6*std_z;
X = linspace(0,2,1000);

h = figure
density = histfit(Z , 50); % 'Normalization', 'Probability');
line([mean_z mean_z], [0 120], 'color','r');
line([under_lim under_lim], [0 120], 'color','r');
line([super_lim super_lim], [0 120], 'color','r');
saveas(h,'/home/romy.beaute/projects/hypnomed/analysis/diffusion_embedding_analysis/density_fisher.png')

outliers = zeros(120,1);
for i=1:120
    if Z(:,i)< under_lim
        outliers(i,:) = 1;
    else
        outliers(i,:) = 0;
    end
end

subjectsList = {
'sub-01'
'sub-01'
'sub-01'
'sub-02'
'sub-02'
'sub-02'
'sub-03'
'sub-03'
'sub-03'
'sub-04'
'sub-04'
'sub-04'
'sub-05'
'sub-05'
'sub-05'
'sub-06'
'sub-06'
'sub-06'
'sub-07'
'sub-07'
'sub-07'
'sub-08'
'sub-08'
'sub-08'
'sub-09'
'sub-09'
'sub-09'
'sub-10'
'sub-10'
'sub-10'
'sub-11'
'sub-11'
'sub-11'
'sub-12'
'sub-12'
'sub-12'
'sub-13'
'sub-13'
'sub-13'
'sub-14'
'sub-14'
'sub-14'
'sub-15'
'sub-15'
'sub-15'
'sub-16'
'sub-16'
'sub-16'
'sub-17'
'sub-17'
'sub-17'
'sub-18'
'sub-18'
'sub-18'
'sub-19'
'sub-19'
'sub-19'
'sub-20'
'sub-20'
'sub-20'
'sub-21'
'sub-21'
'sub-21'
'sub-22'
'sub-22'
'sub-22'
'sub-23'
'sub-23'
'sub-23'
'sub-24'
'sub-24'
'sub-24'
'sub-25'
'sub-25'
'sub-25'
'sub-26'
'sub-26'
'sub-26'
'sub-27'
'sub-27'
'sub-27'
'sub-28'
'sub-28'
'sub-28'
'sub-29'
'sub-29'
'sub-29'
'sub-30'
'sub-30'
'sub-30'
'sub-31'
'sub-31'
'sub-31'
'sub-32'
'sub-32'
'sub-32'
'sub-33'
'sub-33'
'sub-33'
'sub-34'
'sub-34'
'sub-34'
'sub-35'
'sub-35'
'sub-35'
'sub-36'
'sub-36'
'sub-36'
'sub-37'
'sub-37'
'sub-37'
'sub-38'
'sub-38'
'sub-38'
'sub-39'
'sub-39'
'sub-39'
'sub-40'
'sub-40'
'sub-40'
};

% subjectsList = {'sub-002' 
% 'sub-002'
% 'sub-002' 
% 'sub-004'
% 'sub-004'
% 'sub-004'
% 'sub-005'
% 'sub-005'
% 'sub-005'
% 'sub-007'
% 'sub-007'
% 'sub-007'
% 'sub-010'
% 'sub-010'
% 'sub-010'
% 'sub-011'
% 'sub-011'
% 'sub-011'
% 'sub-012'
% 'sub-012'
% 'sub-012'
% 'sub-014'
% 'sub-014'
% 'sub-014'
% 'sub-016'
% 'sub-016'
% 'sub-016'
% 'sub-017'
% 'sub-017'
% 'sub-017'
% 'sub-018'
% 'sub-018'
% 'sub-018'
% 'sub-022'
% 'sub-022'
% 'sub-022'
% 'sub-025'
% 'sub-025'
% 'sub-025'
% 'sub-026'
% 'sub-026'
% 'sub-026'
% 'sub-028'
% 'sub-028'
% 'sub-028'
% 'sub-029'
% 'sub-029'
% 'sub-029'
% 'sub-030'
% 'sub-030'
% 'sub-030'
% 'sub-032'
% 'sub-032'
% 'sub-032'
% 'sub-034'
% 'sub-034'
% 'sub-034'
% 'sub-035'
% 'sub-035'
% 'sub-035'
% 'sub-036'
% 'sub-036'
% 'sub-036'
% 'sub-037'
% 'sub-037'
% 'sub-037'
% 'sub-038'
% 'sub-038'
% 'sub-038'
% 'sub-040'
% 'sub-040'
% 'sub-040'
% 'sub-042'
% 'sub-042'
% 'sub-042'
% 'sub-052'
% 'sub-052'
% 'sub-052'
% 'sub-053'
% 'sub-053'
% 'sub-053'
% 'sub-054'
% 'sub-054'
% 'sub-054'
% 'sub-055'
% 'sub-055'
% 'sub-055'
% 'sub-056'
% 'sub-056'
% 'sub-056'
% 'sub-057'
% 'sub-057'
% 'sub-057'
% 'sub-058'
% 'sub-058'
% 'sub-058'
% 'sub-059'
% 'sub-059'
% 'sub-059'
% 'sub-060'
% 'sub-060'
% 'sub-060'
% 'sub-062'
% 'sub-062'
% 'sub-062'
% 'sub-063'
% 'sub-063'
% 'sub-063'
% 'sub-064'
% 'sub-064'
% 'sub-064'
% 'sub-065'
% 'sub-065'
% 'sub-065'
% 'sub-067'
% 'sub-067'
% 'sub-067'
% 'sub-068'
% 'sub-068'
% 'sub-068'
% 'sub-069'
% 'sub-069'
% 'sub-069'
% 'sub-070'
% 'sub-070'
% 'sub-070'
% 'sub-071'
% 'sub-071'
% 'sub-071'
% 'sub-072'
% 'sub-072'
% 'sub-072'
% 'sub-073'
% 'sub-073'
% 'sub-073'
% 'sub-074'
% 'sub-074'
% 'sub-074'
% 'sub-075'
% 'sub-075'
% 'sub-075'
% 'sub-076'
% 'sub-076'
% 'sub-076'
% 'sub-077'
% 'sub-077'
% 'sub-077'
% 'sub-078'
% 'sub-078'
% 'sub-078'
% 'sub-079'
% 'sub-079'
% 'sub-079'
% 'sub-080'
% 'sub-080'
% 'sub-080'
% 'sub-081'
% 'sub-081'
% 'sub-081'
% 'sub-082'
% 'sub-082'
% 'sub-082'
% 'sub-083'
% 'sub-083'
% 'sub-083'
% 'sub-087'
% 'sub-087'
% 'sub-087'
% 'sub-089'
% 'sub-089'
% 'sub-089'
% 'sub-090'
% 'sub-090'
% 'sub-090'
% 'sub-091'
% 'sub-091'
% 'sub-091'
% 'sub-092'
% 'sub-092'
% 'sub-092'
% 'sub-093'
% 'sub-093'
% 'sub-093'
% 'sub-094'
% 'sub-094'
% 'sub-094'
% 'sub-095'
% 'sub-095'
% 'sub-095'
% 'sub-096'
% 'sub-096'
% 'sub-096'
% 'sub-097'
% 'sub-097'
% 'sub-097'
% 'sub-098'
% 'sub-098'
% 'sub-098'
% 'sub-099'
% 'sub-099'
% 'sub-099'
% 'sub-101'
% 'sub-101'
% 'sub-101'
% 'sub-102'
% 'sub-102'
% 'sub-102'
% 'sub-103'
% 'sub-103'
% 'sub-103'
% 'sub-104'
% 'sub-104'
% 'sub-104'
% 'sub-105'
% 'sub-105'
% 'sub-105'
% 'sub-106'
% 'sub-106'
% 'sub-106'
% 'sub-108'
% 'sub-108'
% 'sub-108'
% 'sub-109'
% 'sub-109'
% 'sub-109'
% };

disp(subjectsList(logical(outliers)))
outliers =num2cell(outliers);

out_tab = cat(2, subjectsList, outliers);

filename = '/home/romy.beaute/projects/hypnomed/analysis/diffusion_embedding_analysis/outliers_fisher.csv';    %must end in csv
writetable( cell2table(out_tab), filename, 'writevariablenames', false, 'quotestrings', true)